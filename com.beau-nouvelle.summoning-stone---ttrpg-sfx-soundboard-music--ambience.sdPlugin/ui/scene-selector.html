<!DOCTYPE html>
<html>

<head lang="en">
    <title>Scene Selector Settings</title>
    <meta charset="utf-8" />
    <style>
        body {
            margin: 0;
            font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
            color: #e5e5e5;
        }

        .sdpi-wrapper {
            padding: 12px;
        }

        .sdpi-item {
            display: flex;
            align-items: center;
            margin-bottom: 12px;
        }

        .sdpi-item-label {
            width: 110px;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.02em;
        }

        .sdpi-item-value {
            flex: 1;
        }

        input,
        select {
            width: 100%;
            padding: 6px 8px;
            border-radius: 6px;
            border: 1px solid #3a3a3a;
            background: #1f1f1f;
            color: #e5e5e5;
        }
    </style>
</head>

<body>
    <div class="sdpi-wrapper">
        <div class="sdpi-item">
            <div class="sdpi-item-label">Campaign</div>
            <select name="campaignId" id="campaign-select" class="sdpi-item-value select"></select>
        </div>
        <div class="sdpi-item">
            <div class="sdpi-item-label">Scene</div>
            <select name="sceneId" id="scene-select" class="sdpi-item-value select" disabled></select>
        </div>
    </div>
    <script>
        const apiBaseUrl = "http://127.0.0.1:7123";
        const campaignSelect = document.getElementById("campaign-select");
        const sceneSelect = document.getElementById("scene-select");

        let websocket = null;
        let uuid = null;
        let settings = {};
        let campaigns = [];

        function sendToStreamDeck(payload) {
            if (!websocket || websocket.readyState !== WebSocket.OPEN) {
                return;
            }
            websocket.send(JSON.stringify(payload));
        }

        function setSettings(updatedSettings) {
            settings = { ...settings, ...updatedSettings };
            sendToStreamDeck({
                event: "setSettings",
                context: uuid,
                payload: settings
            });
        }

        function buildPlaceholderOption(label) {
            const option = document.createElement("option");
            option.value = "";
            option.textContent = label;
            return option;
        }

        function populateCampaigns(list) {
            campaignSelect.replaceChildren();
            campaignSelect.appendChild(buildPlaceholderOption("Select a campaign"));
            list.forEach((campaign) => {
                const option = document.createElement("option");
                option.value = campaign.id;
                option.textContent = campaign.name || "Untitled Campaign";
                campaignSelect.appendChild(option);
            });

            if (settings.campaignId) {
                campaignSelect.value = settings.campaignId;
            }
        }

        function populateScenes(list) {
            sceneSelect.replaceChildren();
            sceneSelect.appendChild(buildPlaceholderOption("Select a scene"));
            list.forEach((scene) => {
                const option = document.createElement("option");
                option.value = scene.id;
                option.textContent = scene.name || "Untitled Scene";
                sceneSelect.appendChild(option);
            });

            sceneSelect.disabled = list.length === 0;

            if (settings.sceneId) {
                sceneSelect.value = settings.sceneId;
            }
        }

        async function fetchCampaigns() {
            const response = await fetch(`${apiBaseUrl}/campaigns`);
            const data = await response.json();
            if (!Array.isArray(data)) {
                return [];
            }
            return data.map((item) => ({
                id: item?.id ?? "",
                name: item?.name ?? "",
                scenes: Array.isArray(item?.scenes) ? item.scenes : null
            })).filter((campaign) => campaign.id);
        }

        async function fetchScenesForCampaign(campaign) {
            if (Array.isArray(campaign.scenes)) {
                return campaign.scenes;
            }

            const encodedId = encodeURIComponent(campaign.id);
            const response = await fetch(`${apiBaseUrl}/campaigns/${encodedId}/scenes`);
            const data = await response.json();
            if (!Array.isArray(data)) {
                return [];
            }
            return data;
        }

        async function loadCampaigns() {
            try {
                campaigns = await fetchCampaigns();
                populateCampaigns(campaigns);

                if (settings.campaignId) {
                    await handleCampaignChange(settings.campaignId, false);
                }
            } catch (error) {
                campaignSelect.replaceChildren();
                const errorOption = buildPlaceholderOption("Unable to load campaigns");
                errorOption.disabled = true;
                campaignSelect.appendChild(errorOption);
                sceneSelect.replaceChildren();
                sceneSelect.disabled = true;
            }
        }

        async function handleCampaignChange(campaignId, clearScene = true) {
            const selectedCampaign = campaigns.find((campaign) => campaign.id === campaignId);
            if (!selectedCampaign) {
                populateScenes([]);
                return;
            }

            if (clearScene) {
                settings.sceneId = "";
                settings.sceneName = "";
            }

            setSettings({
                campaignId: selectedCampaign.id,
                campaignName: selectedCampaign.name || ""
            });

            const scenes = await fetchScenesForCampaign(selectedCampaign);
            populateScenes(
                scenes.map((scene) => ({
                    id: scene?.id ?? "",
                    name: scene?.name ?? ""
                })).filter((scene) => scene.id)
            );
        }

        function registerPropertyInspector(inPort, inUUID, inRegisterEvent, inInfo, inActionInfo) {
            uuid = inUUID;
            const actionInfo = JSON.parse(inActionInfo);
            settings = actionInfo?.payload?.settings ?? {};
            websocket = new WebSocket(`ws://127.0.0.1:${inPort}`);

            websocket.onopen = () => {
                sendToStreamDeck({
                    event: inRegisterEvent,
                    uuid: inUUID
                });
                loadCampaigns();
            };
        }

        campaignSelect.addEventListener("change", (event) => {
            const campaignId = event.target.value;
            handleCampaignChange(campaignId, true);
        });

        sceneSelect.addEventListener("change", (event) => {
            const sceneId = event.target.value;
            const campaignId = campaignSelect.value;
            const campaign = campaigns.find((item) => item.id === campaignId);
            const sceneName = event.target.options[event.target.selectedIndex]?.textContent ?? "";
            setSettings({
                campaignId,
                campaignName: campaign?.name ?? "",
                sceneId,
                sceneName
            });
        });

        window.connectElgatoStreamDeckSocket = registerPropertyInspector;
    </script>
</body>

</html>
